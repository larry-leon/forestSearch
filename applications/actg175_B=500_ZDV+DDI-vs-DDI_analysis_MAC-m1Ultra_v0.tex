\documentclass[9pt]{article}\usepackage[]{graphicx}\usepackage[]{xcolor}
% maxwidth is the original width if it is less than linewidth
% otherwise use linewidth (to make sure the graphics do not exceed the margin)
\makeatletter
\def\maxwidth{ %
  \ifdim\Gin@nat@width>\linewidth
    \linewidth
  \else
    \Gin@nat@width
  \fi
}
\makeatother

\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}%
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}%
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}%
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}%
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}%
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}%
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}%
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}%
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}%
\let\hlipl\hlkwb

\usepackage{framed}
\makeatletter
\newenvironment{kframe}{%
 \def\at@end@of@kframe{}%
 \ifinner\ifhmode%
  \def\at@end@of@kframe{\end{minipage}}%
  \begin{minipage}{\columnwidth}%
 \fi\fi%
 \def\FrameCommand##1{\hskip\@totalleftmargin \hskip-\fboxsep
 \colorbox{shadecolor}{##1}\hskip-\fboxsep
     % There is no \\@totalrightmargin, so:
     \hskip-\linewidth \hskip-\@totalleftmargin \hskip\columnwidth}%
 \MakeFramed {\advance\hsize-\width
   \@totalleftmargin\z@ \linewidth\hsize
   \@setminipage}}%
 {\par\unskip\endMakeFramed%
 \at@end@of@kframe}
\makeatother

\definecolor{shadecolor}{rgb}{.97, .97, .97}
\definecolor{messagecolor}{rgb}{0, 0, 0}
\definecolor{warningcolor}{rgb}{1, 0, 1}
\definecolor{errorcolor}{rgb}{1, 0, 0}
\newenvironment{knitrout}{}{} % an empty environment to be redefined in TeX

\usepackage{alltt}
\usepackage{multicol}
\usepackage{amssymb,mathrsfs,graphicx}
\usepackage{enumerate}
\usepackage{amsthm}
\usepackage{lscape}
\usepackage{pdfpages}
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

\theoremstyle{remark}
\newtheorem{remark}{Remark}

\usepackage[colorlinks=true,linkcolor={blue},citecolor={blue},urlcolor={blue}]{hyperref}
\usepackage{longtable,ctable}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{multirow}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{mathptmx}
\usepackage{natbib}
\usepackage{setspace}

\usepackage[utf8]{inputenc}
\usepackage{pgf}

\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{enumerate}
\usepackage{threeparttable}


\newcommand{\R}{R}
\newcommand{\gbsg}{gbsg}

\def\FsNg{\hbox{FS}(M_{g})}

\def\hhat{\hat\theta(\hat{H})}
\def\hchat{\hat\theta(\hat{H}^{c})}
\def\hknow{\hat\theta(H)}
\def\hcknow{\hat\theta(H^{c})}
\def\hplim{\theta^{\dagger}(H)}
\def\hcplim{\theta^{\dagger}(H^{c})}

\newcommand{\indep}{\perp \!\!\! \perp}

\textheight=9.25in \textwidth=6.0in 
\topmargin=0in
\evensidemargin=0in \oddsidemargin=0in
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\begin{document}

\raggedbottom


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{opts_chunk}\hlopt{$}\hlkwd{set} \hlstd{(}\hlkwc{warning} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{message} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{tidy}\hlstd{=}\hlnum{TRUE}\hlstd{,} \hlkwc{echo}\hlstd{=}\hlnum{TRUE}\hlstd{)}
\hlkwd{options}\hlstd{(}\hlkwc{warn} \hlstd{=} \hlopt{-}\hlnum{1}\hlstd{)}

\hlkwd{rm}\hlstd{(}\hlkwc{list}\hlstd{=}\hlkwd{ls}\hlstd{())}

\hlkwd{library}\hlstd{(survival)}
\hlkwd{library}\hlstd{(knitr)}
\hlkwd{library}\hlstd{(kableExtra)}

\hlkwd{library}\hlstd{(glmnet)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# Loading required package: Matrix}}

{\ttfamily\noindent\itshape\color{messagecolor}{\#\# Loaded glmnet 4.1-7}}\begin{alltt}
\hlkwd{library}\hlstd{(ggplot2)}

\hlcom{# Following loaded in "forest_search_v0.R"}
\hlkwd{suppressMessages}\hlstd{(}\hlkwd{library}\hlstd{(randomForest))}
\hlcom{#library(SPlit)}

\hlkwd{library}\hlstd{(grf)}
\hlkwd{library}\hlstd{(policytree)}
\hlkwd{library}\hlstd{(DiagrammeR)}

\hlcom{#library(cowplot)}

\hlkwd{library}\hlstd{(data.table)}
\hlkwd{library}\hlstd{(plyr)}
\hlkwd{library}\hlstd{(aVirtualTwins)}
\hlcom{# Not sure formatR is needed?}
\hlcom{#library(formatR)}
\hlkwd{suppressMessages}\hlstd{(}\hlkwd{library}\hlstd{(gridExtra))}

\hlkwd{library}\hlstd{(speff2trial)}
\end{alltt}


{\ttfamily\noindent\itshape\color{messagecolor}{\#\# Loading required package: leaps}}\begin{alltt}
\hlcom{# Location where code is stored}
\hlcom{# Modified for MAC}
\hlstd{codepath}\hlkwb{<-}\hlkwd{c}\hlstd{(}\hlstr{"/Users/larryleon/Documents/GitHub/forestSearch/R/"}\hlstd{)}
\hlkwd{source}\hlstd{(}\hlkwd{paste0}\hlstd{(codepath,}\hlstr{"source_forestsearch_v0.R"}\hlstd{))}
\hlkwd{source_fs_functions}\hlstd{(}\hlkwc{file_loc}\hlstd{=codepath)}

\hlcom{# Output grf, fs, and fs bootstrap}
\hlstd{outgrf}\hlkwb{<-}\hlkwd{c}\hlstd{(}\hlstr{"output/actg_2v3_grf.Rdata"}\hlstd{)}
\hlstd{outfs}\hlkwb{<-}\hlkwd{c}\hlstd{(}\hlstr{"output/actg_2v3_fs.Rdata"}\hlstd{)}
\hlcom{# Boots=500}
\hlstd{outfsboot}\hlkwb{<-}\hlkwd{c}\hlstd{(}\hlstr{"output/actg_2v3_fsboot_B=500.Rdata"}\hlstd{)}
\hlcom{# Set to null if not outputting}
\hlcom{#outgrf<-outfs<-outfsboot<-NULL}
\end{alltt}
\end{kframe}
\end{knitrout}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{t.start.all} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}
\hlcom{# GRF analysis To guide selection of binary cutpoints}
\hlstd{df.analysis} \hlkwb{<-} \hlkwd{subset}\hlstd{(ACTG175, arms} \hlopt{%in%} \hlkwd{c}\hlstd{(}\hlnum{2}\hlstd{,} \hlnum{3}\hlstd{))}

\hlstd{df.analysis} \hlkwb{<-} \hlkwd{within}\hlstd{(df.analysis, \{}
    \hlstd{id} \hlkwb{<-} \hlkwd{as.numeric}\hlstd{(}\hlkwd{c}\hlstd{(}\hlnum{1}\hlopt{:}\hlkwd{nrow}\hlstd{(df.analysis)))}
    \hlstd{time_days} \hlkwb{<-} \hlstd{days}
    \hlstd{treat} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(arms} \hlopt{==} \hlnum{2}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
\hlstd{\})}

\hlcom{# plot(survfit(Surv(time_days,cens)~treat,data=df.analysis))}
\hlkwd{coxph}\hlstd{(}\hlkwd{Surv}\hlstd{(time_days, cens)} \hlopt{~} \hlstd{treat,} \hlkwc{data} \hlstd{= df.analysis)}
\end{alltt}
\begin{verbatim}
## Call:
## coxph(formula = Surv(time_days, cens) ~ treat, data = df.analysis)
## 
##          coef exp(coef) se(coef)      z     p
## treat -0.1102    0.8957   0.1303 -0.845 0.398
## 
## Likelihood ratio test=0.72  on 1 df, p=0.3974
## n= 1085, number of events= 237
\end{verbatim}
\begin{alltt}
\hlstd{confounders.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"age"}\hlstd{,} \hlstr{"wtkg"}\hlstd{,} \hlstr{"karnof"}\hlstd{,} \hlstr{"cd40"}\hlstd{,} \hlstr{"cd80"}\hlstd{,} \hlstr{"hemo"}\hlstd{,} \hlstr{"homo"}\hlstd{,} \hlstr{"drugs"}\hlstd{,}
    \hlstr{"race"}\hlstd{,} \hlstr{"gender"}\hlstd{,} \hlstr{"oprior"}\hlstd{,} \hlstr{"symptom"}\hlstd{)}
\hlstd{outcome.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"time_days"}\hlstd{)}
\hlstd{event.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"cens"}\hlstd{)}
\hlstd{id.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"id"}\hlstd{)}
\hlstd{treat.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"treat"}\hlstd{)}

\hlstd{n.min} \hlkwb{<-} \hlnum{60}
\hlstd{dmin.grf} \hlkwb{<-} \hlnum{12}
\hlstd{frac.tau} \hlkwb{<-} \hlnum{0.8}

\hlstd{grf.est} \hlkwb{<-} \hlkwd{grf.subg.harm.survival}\hlstd{(}\hlkwc{data} \hlstd{= df.analysis,} \hlkwc{confounders.name} \hlstd{= confounders.name,}
    \hlkwc{outcome.name} \hlstd{= outcome.name,} \hlkwc{event.name} \hlstd{= event.name,} \hlkwc{id.name} \hlstd{= id.name,} \hlkwc{treat.name} \hlstd{= treat.name,}
    \hlkwc{n.min} \hlstd{= n.min,} \hlkwc{dmin.grf} \hlstd{= dmin.grf,} \hlkwc{frac.tau} \hlstd{= frac.tau,} \hlkwc{details} \hlstd{=} \hlnum{TRUE}\hlstd{)}
\end{alltt}
\begin{verbatim}
## tau= 816.8 
##    leaf.node control.mean control.size control.se treated.mean treated.size
## 1          2   -22.082439   827.000000   9.326913    22.082439   827.000000
## 2          3    21.867387   258.000000  20.629486   -21.867387   258.000000
## 3          4    18.085937   172.000000  18.504493   -18.085937   172.000000
## 4          5   -80.927682   126.000000  28.142912    80.927682   126.000000
## 5          6   -30.162237   518.000000  11.160792    30.162237   518.000000
## 6          7    37.508381   269.000000  20.579908   -37.508381   269.000000
## 31        10   -39.786067   456.000000  12.996263    39.786067   456.000000
## 41        11     8.510100   181.000000  10.408829    -8.510100   181.000000
## 51        12   -81.900991   112.000000  29.240477    81.900991   112.000000
## 61        13    74.486346   124.000000  25.937852   -74.486346   124.000000
## 7         14   104.991943    64.000000  56.272715  -104.991943    64.000000
## 8         15   -72.420207    81.000000  30.592268    72.420207    81.000000
##     treated.se       diff depth
## 1     9.326913  -44.16488     1
## 2    20.629486   43.73477     1
## 3    18.504493   36.17187     2
## 4    28.142912 -161.85536     2
## 5    11.160792  -60.32447     2
## 6    20.579908   75.01676     2
## 31   12.996263  -79.57213     3
## 41   10.408829   17.02020     3
## 51   29.240477 -163.80198     3
## 61   25.937852  148.97269     3
## 7    56.272715  209.98389     3
## 8    30.592268 -144.84041     3
##   leaf.node control.mean control.size control.se treated.mean treated.size
## 7        14    104.99194     64.00000   56.27272   -104.99194     64.00000
##   treated.se     diff depth
## 7   56.27272 209.9839     3
\end{verbatim}
\begin{alltt}
\hlkwd{cat}\hlstd{(}\hlstr{"Truncation point for RMST:"}\hlstd{,} \hlkwd{c}\hlstd{(grf.est}\hlopt{$}\hlstd{tau.rmst),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Truncation point for RMST: 816.8
\end{verbatim}
\begin{alltt}
\hlcom{# Plot manually}

\hlcom{# plot(grf.est$tree) plot(grf.est$tree1) plot(grf.est$tree2)}
\hlcom{# plot(grf.est$tree3)}

\hlstd{df0.grf} \hlkwb{<-} \hlkwd{subset}\hlstd{(grf.est}\hlopt{$}\hlstd{data, treat.recommend} \hlopt{==} \hlnum{0}\hlstd{)}
\hlstd{df1.grf} \hlkwb{<-} \hlkwd{subset}\hlstd{(grf.est}\hlopt{$}\hlstd{data, treat.recommend} \hlopt{==} \hlnum{1}\hlstd{)}

\hlcom{# Terminal leaf corresponding to selected SG}
\hlkwd{cat}\hlstd{(}\hlstr{"Terminal leaf:"}\hlstd{,} \hlkwd{c}\hlstd{(grf.est}\hlopt{$}\hlstd{sg.harm.id),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Terminal leaf: karnof <= 90
\end{verbatim}
\begin{alltt}
\hlcom{# action=1 --> recommend control}

\hlcom{# Manually identify the subgroup looking at tree and terminal leaf}
\hlkwd{print}\hlstd{(}\hlkwd{dim}\hlstd{(df0.grf))}
\end{alltt}
\begin{verbatim}
## [1] 64 34
\end{verbatim}
\begin{alltt}
\hlstd{check} \hlkwb{<-} \hlkwd{subset}\hlstd{(df.analysis, karnof} \hlopt{<=} \hlnum{90} \hlopt{&} \hlstd{cd80} \hlopt{>} \hlnum{1034} \hlopt{&} \hlstd{age} \hlopt{>} \hlnum{37}\hlstd{)}
\hlkwd{print}\hlstd{(}\hlkwd{dim}\hlstd{(check))}
\end{alltt}
\begin{verbatim}
## [1] 64 29
\end{verbatim}
\begin{alltt}
\hlcom{# plot(survfit(Surv(time_days,cens)~treat,data=df.analysis))}
\hlcom{# coxph(Surv(time_days,cens)~treat,data=df.analysis)}

\hlkwa{if} \hlstd{(}\hlopt{!}\hlkwd{is.null}\hlstd{(outgrf))} \hlkwd{save}\hlstd{(grf.est,} \hlkwc{file} \hlstd{= outgrf)}
\end{alltt}
\end{kframe}
\end{knitrout}



\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{t.done} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}
\hlstd{t.min} \hlkwb{<-} \hlstd{(t.done} \hlopt{-} \hlstd{t.start.all)}\hlopt{/}\hlnum{60}
\hlkwd{cat}\hlstd{(}\hlstr{"Minutes and hours for GRF estimation"}\hlstd{,} \hlkwd{c}\hlstd{(t.min, t.min}\hlopt{/}\hlnum{60}\hlstd{),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Minutes and hours for GRF estimation 2.919333 0.04865556
\end{verbatim}
\end{kframe}
\end{knitrout}

\begin{figure}[h!]
\begin{center}
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlkwd{par}\hlstd{(}\hlkwc{mfrow} \hlstd{=} \hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,} \hlnum{2}\hlstd{))}
\hlkwd{plot.subgroup}\hlstd{(}\hlkwc{sub1} \hlstd{= df0.grf,} \hlkwc{sub1C} \hlstd{= df1.grf,} \hlkwc{tte.name} \hlstd{=} \hlstr{"time_days"}\hlstd{,} \hlkwc{event.name} \hlstd{=} \hlstr{"cens"}\hlstd{,}
    \hlkwc{treat.name} \hlstd{=} \hlstr{"treat"}\hlstd{,} \hlkwc{fix.rows} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{byrisk} \hlstd{=} \hlnum{200}\hlstd{,} \hlkwc{show.med} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{ymin} \hlstd{=} \hlnum{0.4}\hlstd{)}
\end{alltt}
\end{kframe}
\includegraphics[width=400px,height=400px]{figure/grf_sg-1} 
\end{knitrout}
\end{center}
\end{figure}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{t.start} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}

\hlkwd{cat}\hlstd{(}\hlstr{"GRF variables in selected tree"}\hlstd{,} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## GRF variables in selected tree
\end{verbatim}
\begin{alltt}
\hlkwd{print}\hlstd{(grf.est}\hlopt{$}\hlstd{tree.names)}
\end{alltt}
\begin{verbatim}
## [1] "age"    "cd80"   "wtkg"   "cd40"   "karnof"
\end{verbatim}
\begin{alltt}
\hlkwd{cat}\hlstd{(}\hlstr{"GRF cuts wrt selected tree:"}\hlstd{,} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## GRF cuts wrt selected tree:
\end{verbatim}
\begin{alltt}
\hlkwd{print}\hlstd{(grf.est}\hlopt{$}\hlstd{tree.cuts)}
\end{alltt}
\begin{verbatim}
## [1] "age <= 37"     "cd80 <= 499"   "cd80 <= 1034"  "wtkg <= 64.64"
## [5] "cd40 <= 417"   "cd80 <= 680"   "karnof <= 90"
\end{verbatim}
\begin{alltt}
\hlcom{# Reduce dimension via Cox lasso}

\hlstd{xx} \hlkwb{<-} \hlkwd{as.matrix}\hlstd{(df.analysis[, confounders.name])}
\hlstd{yy} \hlkwb{<-} \hlkwd{as.matrix}\hlstd{(df.analysis[,} \hlkwd{c}\hlstd{(}\hlstr{"time_days"}\hlstd{,} \hlstr{"cens"}\hlstd{)])}
\hlkwd{colnames}\hlstd{(yy)} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"time"}\hlstd{,} \hlstr{"status"}\hlstd{)}

\hlstd{cvfit} \hlkwb{<-} \hlkwd{cv.glmnet}\hlstd{(xx, yy,} \hlkwc{family} \hlstd{=} \hlstr{"cox"}\hlstd{)}  \hlcom{#first do 10-fold cross-validation to select lambda}

\hlstd{m} \hlkwb{<-} \hlkwd{glmnet}\hlstd{(xx, yy,} \hlkwc{family} \hlstd{=} \hlstr{"cox"}\hlstd{,} \hlkwc{lambda} \hlstd{= cvfit}\hlopt{$}\hlstd{lambda.min)}  \hlcom{#plugin the optimal lambda}

\hlstd{conflasso.name} \hlkwb{<-} \hlstd{confounders.name[}\hlkwd{which}\hlstd{(m}\hlopt{$}\hlstd{beta} \hlopt{!=} \hlnum{0}\hlstd{)]}

\hlkwd{cat}\hlstd{(}\hlstr{"Cox-LASSO selected:"}\hlstd{,} \hlkwd{c}\hlstd{(conflasso.name),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Cox-LASSO selected: age wtkg karnof cd40 cd80 drugs symptom
\end{verbatim}
\begin{alltt}
\hlkwd{cat}\hlstd{(}\hlstr{"GRF cuts wrt selected tree:"}\hlstd{,} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## GRF cuts wrt selected tree:
\end{verbatim}
\begin{alltt}
\hlkwd{print}\hlstd{(grf.est}\hlopt{$}\hlstd{tree.cuts)}
\end{alltt}
\begin{verbatim}
## [1] "age <= 37"     "cd80 <= 499"   "cd80 <= 1034"  "wtkg <= 64.64"
## [5] "cd40 <= 417"   "cd80 <= 680"   "karnof <= 90"
\end{verbatim}
\begin{alltt}
\hlcom{# Considering continuous factors per GRF cuts Only *also* considering drugs and}
\hlcom{# symptom per lasso}

\hlstd{df.analysis} \hlkwb{<-} \hlkwd{within}\hlstd{(df.analysis, \{}
    \hlstd{z1a} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(age} \hlopt{<=} \hlnum{37}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
    \hlstd{z1b} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(age} \hlopt{<=} \hlkwd{median}\hlstd{(age),} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
    \hlstd{z2} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(wtkg} \hlopt{<=} \hlnum{65}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
    \hlstd{z3} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(karnof} \hlopt{<=} \hlnum{90}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
    \hlstd{z4} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(cd40} \hlopt{<=} \hlnum{417}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
    \hlstd{z5a} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(cd80} \hlopt{<=} \hlnum{499}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
    \hlstd{z5b} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(cd80} \hlopt{<=} \hlnum{680}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
    \hlstd{z5c} \hlkwb{<-} \hlkwd{ifelse}\hlstd{(cd80} \hlopt{<=} \hlnum{1034}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{0}\hlstd{)}
    \hlcom{# z6<-hemo z7<-homo}
    \hlstd{z8} \hlkwb{<-} \hlstd{drugs}
    \hlcom{# z9<-race z10<-gender z11<-oprior}
    \hlstd{z12} \hlkwb{<-} \hlstd{symptom}
    \hlcom{# Convert to factors}
    \hlstd{v1a} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z1a)}
    \hlstd{v1b} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z1b)}
    \hlstd{v2} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z2)}
    \hlstd{v3} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z3)}
    \hlstd{v4} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z4)}
    \hlstd{v5a} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z5a)}
    \hlstd{v5b} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z5b)}
    \hlstd{v5c} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z5c)}
    \hlstd{v6} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z8)}
    \hlstd{v7} \hlkwb{<-} \hlkwd{as.factor}\hlstd{(z12)}
\hlstd{\})}

\hlstd{FSconfounders.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"v1a"}\hlstd{,} \hlstr{"v1b"}\hlstd{,} \hlstr{"v2"}\hlstd{,} \hlstr{"v3"}\hlstd{,} \hlstr{"v4"}\hlstd{,} \hlstr{"v5a"}\hlstd{,} \hlstr{"v5b"}\hlstd{,} \hlstr{"v5c"}\hlstd{,} \hlstr{"v6"}\hlstd{,}
    \hlstr{"v7"}\hlstd{)}

\hlstd{outcome.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"time_days"}\hlstd{)}
\hlstd{event.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"cens"}\hlstd{)}
\hlstd{id.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"id"}\hlstd{)}
\hlstd{treat.name} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"treat"}\hlstd{)}

\hlstd{df.confounders} \hlkwb{<-} \hlstd{df.analysis[, FSconfounders.name]}
\hlstd{df.confounders} \hlkwb{<-} \hlkwd{dummy}\hlstd{(df.confounders)}

\hlstd{hr.threshold} \hlkwb{<-} \hlnum{1.5}  \hlcom{# Initital candidates }
\hlstd{hr.consistency} \hlkwb{<-} \hlnum{1.25}  \hlcom{# Candidates for many splits}

\hlstd{pconsistency.threshold} \hlkwb{<-} \hlnum{0.9}
\hlstd{maxk} \hlkwb{<-} \hlnum{4}
\hlcom{# maxk is max # of covariates in combination Since we want to allow generation}
\hlcom{# of intervals for single covariate allowing for 4 can yield v1, v2 (say), and}
\hlcom{# v3,v4 with v3 and v4 generating intervals for a single covariate}

\hlcom{# Limit timing for forestsearch}
\hlstd{max.minutes} \hlkwb{<-} \hlnum{60}
\hlstd{nmin.fs} \hlkwb{<-} \hlnum{60}
\hlcom{# stop.threshold<-0.60 # If any sg meets this, then choose this (stop here);}
\hlstd{m1.threshold} \hlkwb{<-} \hlnum{Inf}  \hlcom{# Turning this off (Default)}
\hlstd{stop.threshold} \hlkwb{<-} \hlnum{1}
\hlcom{# =1 will run through all sg's meeting HR criteria}
\hlstd{fs.splits} \hlkwb{<-} \hlnum{1000}  \hlcom{# How many times to split for consistency}
\hlcom{# vi is % factor is selected in cross-validation --> higher more important}
\hlstd{vi.grf.min} \hlkwb{<-} \hlnum{0.2}
\hlcom{# Null, turns off grf screening Set to 5 for this heavily censored data}
\hlstd{d.min} \hlkwb{<-} \hlnum{5}  \hlcom{# Min number of events for both arms (d0.min=d1.min=d.min)}
\hlcom{# default=5}

\hlstd{sg_focus} \hlkwb{<-} \hlstr{"hr"}
\hlstd{split_method} \hlkwb{<-} \hlstr{"Random"}
\hlstd{pstop_futile} \hlkwb{<-} \hlnum{0.3}
\hlcom{# Stops the consistency evaluation after first subgroup with consistency below}
\hlcom{# pstop_futile With idea that since SG's are sorted by hazard ratio estimates,}
\hlcom{# once consistency is below pstop_futile it seems unlikely that SG's with lower}
\hlcom{# hr's will reach the required consistency criterion}


\hlstd{fs.est} \hlkwb{<-} \hlkwd{forestsearch}\hlstd{(}\hlkwc{df} \hlstd{= df.analysis,} \hlkwc{confounders.name} \hlstd{= FSconfounders.name,} \hlkwc{df.predict} \hlstd{= df.analysis,}
    \hlkwc{details} \hlstd{=} \hlnum{TRUE}\hlstd{,} \hlkwc{sg_focus} \hlstd{= sg_focus,} \hlkwc{split_method} \hlstd{= split_method,} \hlkwc{pstop_futile} \hlstd{= pstop_futile,}
    \hlkwc{outcome.name} \hlstd{= outcome.name,} \hlkwc{treat.name} \hlstd{= treat.name,} \hlkwc{event.name} \hlstd{= event.name,}
    \hlkwc{id.name} \hlstd{= id.name,} \hlkwc{n.min} \hlstd{= nmin.fs,} \hlkwc{hr.threshold} \hlstd{= hr.threshold,} \hlkwc{hr.consistency} \hlstd{= hr.consistency,}
    \hlkwc{fs.splits} \hlstd{= fs.splits,} \hlkwc{stop.threshold} \hlstd{= stop.threshold,} \hlkwc{d0.min} \hlstd{= d.min,} \hlkwc{d1.min} \hlstd{= d.min,}
    \hlkwc{pconsistency.threshold} \hlstd{= pconsistency.threshold,} \hlkwc{max.minutes} \hlstd{= max.minutes,} \hlkwc{maxk} \hlstd{= maxk,}
    \hlkwc{plot.sg} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{vi.grf.min} \hlstd{= vi.grf.min)}
\end{alltt}
\begin{verbatim}
## Confounders per grf screening v2 v7 v1a v3 v5b v6 v5c v1b v5a v4 
## Number of possible subgroups= 1048575 
## Number of possible subgroups (in millions)= 1.048575 
## # of subgroups based on # variables > k.max and excluded 1042380 
## k.max= 4 
## Events criteria for control,exp= 5 5 
## # of subgroups with events less than criteria: control, experimental 3623 3913 
## # of subgroups meeting all criteria = 1441 
## # of subgroups fitted (Cox model estimable) = 1441 
## Minutes= 0.11785 
## Number of criteria not met for subgroup evaluation 
## crit.failure
##       0       1       2       3       4 
## 1043821     291    3233     479     751 
## Number of subgroups meeting HR threshold 91 
## Subgroups (1st 10) meeting overall screening thresholds (HR, m1) sorted by focus: (m1,sg_focus)= Inf hr 
##     K   n  E d1  m1  m0   HR L(HR) U(HR) v2.0 v2.1 v7.0 v7.1 v1a.0 v1a.1 v3.0
##  1: 4 106 21 15 Inf Inf 3.01  1.17  7.77    0    0    0    0     1     0    0
##  2: 4  99 16 11 Inf Inf 2.72  0.95  7.84    1    0    0    0     1     0    0
##  3: 3 124 23 16 Inf Inf 2.62  1.08  6.36    0    0    0    0     1     0    0
##  4: 4  88 30 20 Inf Inf 2.49  1.17  5.34    0    0    0    0     1     0    0
##  5: 4  97 29 18 Inf Inf 2.22  1.05  4.70    0    0    0    0     1     0    0
##  6: 4 110 19 13 Inf Inf 2.20  0.84  5.80    0    0    1    0     1     0    1
##  7: 4  98 31 19 Inf Inf 2.05  0.99  4.22    1    0    0    0     1     0    0
##  8: 4 146 33 18 Inf Inf 2.02  1.02  4.01    1    0    0    0     0     0    0
##  9: 3 120 36 22 Inf Inf 2.02  1.03  3.94    0    0    0    0     1     0    0
## 10: 4 157 33 22 Inf Inf 2.01  0.97  4.14    0    0    1    0     1     0    0
##     v3.1 v5b.0 v5b.1 v6.0 v6.1 v5c.0 v5c.1 v1b.0 v1b.1 v5a.0 v5a.1 v4.0 v4.1
##  1:    0     1     0    1    0     0     1     0     0     0     0    0    0
##  2:    0     1     0    0    0     0     1     0     0     0     0    0    0
##  3:    0     1     0    0    0     0     1     0     0     0     0    0    0
##  4:    1     1     0    0    0     0     0     0     0     0     0    0    1
##  5:    1     1     0    1    0     0     0     0     0     0     0    0    0
##  6:    0     0     0    0    0     0     1     0     0     0     0    0    0
##  7:    1     1     0    0    0     0     0     0     0     0     0    0    0
##  8:    1     0     0    1    0     0     0     0     1     0     0    0    0
##  9:    1     1     0    0    0     0     0     0     0     0     0    0    0
## 10:    0     0     0    0    0     0     1     0     0     1     0    0    0
## Consistency 0.95 
## Splitting method, # of splits= Random 1000 
## Model, % Consistency Met= v1a.0 v5b.0 v6.0 v5c.1 0.95 
## Consistency 0.631 
## Consistency 0.913 
## Splitting method, # of splits= Random 1000 
## Model, % Consistency Met= v1a.0 v5b.0 v5c.1 0.913 
## Consistency 0.941 
## Splitting method, # of splits= Random 1000 
## Model, % Consistency Met= v1a.0 v3.1 v5b.0 v4.1 0.941 
## Consistency 0.641 
## Consistency 0.333 
## Consistency 0.533 
## Consistency 0.542 
## Consistency 0.493 
## Consistency 0.404 
## Consistency 0.501 
## Consistency 0.835 
## Consistency 0.835 
## Consistency 0.17 
## Number of subgroups meeting consistency criteria= 3 
##    p.consistency Nsg group.id m.index K   M.1   M.2   M.3   M.4
## 1:          0.95 106       21       1 4 v1a.0 v5b.0  v6.0 v5c.1
## 2:         0.913 124       23       3 3 v1a.0 v5b.0 v5c.1      
## 3:         0.941  88       91       4 4 v1a.0  v3.1 v5b.0  v4.1
##    p.consistency Nsg group.id m.index K   M.1   M.2   M.3   M.4
## 1:         0.950 106       21       1 4 v1a.0 v5b.0  v6.0 v5c.1
## 2:         0.941  88       91       4 4 v1a.0  v3.1 v5b.0  v4.1
## 3:         0.913 124       23       3 3 v1a.0 v5b.0 v5c.1
\end{verbatim}
\begin{alltt}
\hlstd{xx} \hlkwb{<-} \hlstd{fs.est}\hlopt{$}\hlstd{find.grps}\hlopt{$}\hlstd{out.found}\hlopt{$}\hlstd{hr.subgroups}
\hlstd{covs.found} \hlkwb{<-} \hlstd{xx[,} \hlopt{-}\hlkwd{c}\hlstd{(}\hlnum{1}\hlopt{:}\hlnum{10}\hlstd{)]}
\hlstd{covs.most} \hlkwb{<-} \hlkwd{apply}\hlstd{(covs.found,} \hlnum{2}\hlstd{, sum)}
\hlstd{covs.most} \hlkwb{<-} \hlstd{covs.most[covs.most} \hlopt{>} \hlnum{0}\hlstd{]}
\hlkwd{print}\hlstd{(covs.most)}
\end{alltt}
\begin{verbatim}
##  v2.0  v7.0  v7.1 v1a.0 v1a.1  v3.0  v3.1 v5b.0 v5b.1  v6.0 v5c.0 v5c.1 v1b.0 
##    37    17     1    22    16     7    50    23    17    31    19    15     5 
## v1b.1 v5a.0 v5a.1  v4.0  v4.1 
##    33    12     3    11    16
\end{verbatim}
\begin{alltt}
\hlkwd{print}\hlstd{(fs.est}\hlopt{$}\hlstd{grp.consistency}\hlopt{$}\hlstd{result)}
\end{alltt}
\begin{verbatim}
##    p.consistency Nsg group.id m.index K   M.1   M.2   M.3   M.4
## 1:         0.950 106       21       1 4 v1a.0 v5b.0  v6.0 v5c.1
## 2:         0.941  88       91       4 4 v1a.0  v3.1 v5b.0  v4.1
## 3:         0.913 124       23       3 3 v1a.0 v5b.0 v5c.1
\end{verbatim}
\begin{alltt}
\hlstd{df0.fs} \hlkwb{<-} \hlkwd{subset}\hlstd{(fs.est}\hlopt{$}\hlstd{df.pred, treat.recommend} \hlopt{==} \hlnum{0}\hlstd{)}
\hlstd{df1.fs} \hlkwb{<-} \hlkwd{subset}\hlstd{(fs.est}\hlopt{$}\hlstd{df.pred, treat.recommend} \hlopt{==} \hlnum{1}\hlstd{)}

\hlkwa{if} \hlstd{(}\hlopt{!}\hlkwd{is.null}\hlstd{(outfs))} \hlkwd{save}\hlstd{(fs.est, df.analysis, FSconfounders.name,} \hlkwc{file} \hlstd{= outfs)}
\end{alltt}
\end{kframe}
\end{knitrout}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{t.done} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}
\hlstd{t.min} \hlkwb{<-} \hlstd{(t.done} \hlopt{-} \hlstd{t.start)}\hlopt{/}\hlnum{60}
\hlkwd{cat}\hlstd{(}\hlstr{"Minutes and hours for FS estimation"}\hlstd{,} \hlkwd{c}\hlstd{(t.min, t.min}\hlopt{/}\hlnum{60}\hlstd{),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Minutes and hours for FS estimation 0.4069833 0.006783056
\end{verbatim}
\end{kframe}
\end{knitrout}


\begin{figure}[h!]
\begin{center}
\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# Compare with GRF}
\hlkwd{layout}\hlstd{(}\hlkwd{matrix}\hlstd{(}\hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,} \hlnum{2}\hlstd{,} \hlnum{3}\hlstd{,} \hlnum{4}\hlstd{),} \hlnum{2}\hlstd{,} \hlnum{2}\hlstd{,} \hlkwc{byrow} \hlstd{=} \hlnum{TRUE}\hlstd{))}
\hlkwd{plot.subgroup}\hlstd{(}\hlkwc{sub1} \hlstd{= df0.grf,} \hlkwc{sub1C} \hlstd{= df1.grf,} \hlkwc{tte.name} \hlstd{=} \hlstr{"time_days"}\hlstd{,} \hlkwc{event.name} \hlstd{=} \hlstr{"cens"}\hlstd{,}
    \hlkwc{treat.name} \hlstd{=} \hlstr{"treat"}\hlstd{,} \hlkwc{fix.rows} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{byrisk} \hlstd{=} \hlnum{200}\hlstd{,} \hlkwc{show.med} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{ymin} \hlstd{=} \hlnum{0.4}\hlstd{,}
    \hlkwc{subtitle1} \hlstd{=} \hlstr{"(a)"}\hlstd{,} \hlkwc{subtitle2} \hlstd{=} \hlstr{"(b)"}\hlstd{)}
\hlkwd{plot.subgroup}\hlstd{(}\hlkwc{sub1} \hlstd{= df0.fs,} \hlkwc{sub1C} \hlstd{= df1.fs,} \hlkwc{tte.name} \hlstd{=} \hlstr{"time_days"}\hlstd{,} \hlkwc{event.name} \hlstd{=} \hlstr{"cens"}\hlstd{,}
    \hlkwc{treat.name} \hlstd{=} \hlstr{"treat"}\hlstd{,} \hlkwc{fix.rows} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{byrisk} \hlstd{=} \hlnum{200}\hlstd{,} \hlkwc{show.med} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{ymin} \hlstd{=} \hlnum{0.4}\hlstd{,}
    \hlkwc{subtitle1} \hlstd{=} \hlstr{"(c)"}\hlstd{,} \hlkwc{subtitle2} \hlstd{=} \hlstr{"(d)"}\hlstd{)}
\end{alltt}
\end{kframe}
\includegraphics[width=400px,height=400px]{figure/grf-fs_sg-1} 
\end{knitrout}
\end{center}
\end{figure}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{t.start} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}
\hlcom{# Note, the elements above will need to be re-initiated if running separate}
\hlcom{# from above E.g., outcome.names, event.name, ... hr.threshold, etc.}

\hlkwd{library}\hlstd{(doParallel)}
\hlkwd{registerDoParallel}\hlstd{(parallel}\hlopt{::}\hlkwd{detectCores}\hlstd{(}\hlkwc{logical} \hlstd{=} \hlnum{FALSE}\hlstd{))}

\hlstd{cox.formula.boot} \hlkwb{<-} \hlkwd{as.formula}\hlstd{(}\hlkwd{paste}\hlstd{(}\hlstr{"Surv(time_days,cens)~treat"}\hlstd{))}
\hlstd{split_method} \hlkwb{<-} \hlstr{"Random"}
\hlstd{est.loghr} \hlkwb{<-} \hlnum{TRUE}

\hlstd{confounders.name} \hlkwb{<-} \hlstd{FSconfounders.name}
\hlstd{stop.threshold} \hlkwb{<-} \hlnum{0.99}
\hlstd{fs.splits} \hlkwb{<-} \hlnum{1000}
\hlstd{max.minutes} \hlkwb{<-} \hlnum{6}

\hlcom{# Suggest running 50, first ... to get timing estimate}
\hlstd{NB} \hlkwb{<-} \hlnum{10}

\hlstd{df_temp} \hlkwb{<-} \hlstd{fs.est}\hlopt{$}\hlstd{df.pred[,} \hlkwd{c}\hlstd{(}\hlstr{"id"}\hlstd{,} \hlstr{"treat.recommend"}\hlstd{)]}
\hlstd{dfa} \hlkwb{<-} \hlkwd{merge}\hlstd{(df.analysis, df_temp,} \hlkwc{by} \hlstd{=} \hlstr{"id"}\hlstd{)}
\hlstd{df_boot_analysis} \hlkwb{<-} \hlstd{dfa}

\hlstd{fitH} \hlkwb{<-} \hlkwd{get_Cox_sg}\hlstd{(}\hlkwc{df_sg} \hlstd{=} \hlkwd{subset}\hlstd{(df_boot_analysis, treat.recommend} \hlopt{==} \hlnum{0}\hlstd{),} \hlkwc{cox.formula} \hlstd{= cox.formula.boot,}
    \hlkwc{est.loghr} \hlstd{= est.loghr)}
\hlstd{H_obs} \hlkwb{<-} \hlstd{fitH}\hlopt{$}\hlstd{est_obs}  \hlcom{# log(hr) scale}
\hlstd{seH_obs} \hlkwb{<-} \hlstd{fitH}\hlopt{$}\hlstd{se_obs}
\hlcom{# Hc observed estimates}
\hlstd{fitHc} \hlkwb{<-} \hlkwd{get_Cox_sg}\hlstd{(}\hlkwc{df_sg} \hlstd{=} \hlkwd{subset}\hlstd{(df_boot_analysis, treat.recommend} \hlopt{==} \hlnum{1}\hlstd{),} \hlkwc{cox.formula} \hlstd{= cox.formula.boot,}
    \hlkwc{est.loghr} \hlstd{= est.loghr)}
\hlstd{Hc_obs} \hlkwb{<-} \hlstd{fitHc}\hlopt{$}\hlstd{est_obs}
\hlstd{seHc_obs} \hlkwb{<-} \hlstd{fitHc}\hlopt{$}\hlstd{se_obs}
\hlkwd{rm}\hlstd{(}\hlstr{"fitH"}\hlstd{,} \hlstr{"fitHc"}\hlstd{)}

\hlstd{Ystar_mat} \hlkwb{<-} \hlkwd{bootYstar}\hlstd{(\{}
    \hlstd{ystar} \hlkwb{<-} \hlkwd{get_Ystar}\hlstd{(boot)}
\hlstd{\},} \hlkwc{boots} \hlstd{= NB,} \hlkwc{seed} \hlstd{=} \hlnum{8316951}\hlstd{,} \hlkwc{counter} \hlstd{=} \hlstr{"boot"}\hlstd{,} \hlkwc{export} \hlstd{= fun_arg_list_boot)}
\hlcom{# Check dimension}
\hlkwa{if} \hlstd{(}\hlkwd{dim}\hlstd{(Ystar_mat)[}\hlnum{1}\hlstd{]} \hlopt{!=} \hlstd{NB} \hlopt{|} \hlkwd{dim}\hlstd{(Ystar_mat)[}\hlnum{2}\hlstd{]} \hlopt{!=} \hlkwd{nrow}\hlstd{(df_boot_analysis))} \hlkwd{stop}\hlstd{(}\hlstr{"Dimension of Ystar_mat does not match"}\hlstd{)}

\hlstd{tB.start} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}
\hlcom{# Bootstraps}
\hlstd{resB} \hlkwb{<-} \hlkwd{bootPar}\hlstd{(\{}
    \hlstd{ans} \hlkwb{<-} \hlkwd{fsboot_forparallel}\hlstd{(boot)}
\hlstd{\},} \hlkwc{boots} \hlstd{= NB,} \hlkwc{seed} \hlstd{=} \hlnum{8316951}\hlstd{,} \hlkwc{counter} \hlstd{=} \hlstr{"boot"}\hlstd{,} \hlkwc{export} \hlstd{= fun_arg_list_boot)}
\hlstd{tB.now} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}
\hlstd{tB.min} \hlkwb{<-} \hlstd{(tB.now} \hlopt{-} \hlstd{tB.start)}\hlopt{/}\hlnum{60}

\hlstd{doParallel}\hlopt{::}\hlkwd{stopImplicitCluster}\hlstd{()}

\hlkwd{cat}\hlstd{(}\hlstr{"Minutes for Boots"}\hlstd{,} \hlkwd{c}\hlstd{(NB, tB.min),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Minutes for Boots 10 1.30875
\end{verbatim}
\begin{alltt}
\hlkwd{cat}\hlstd{(}\hlstr{"Projection per 100"}\hlstd{,} \hlkwd{c}\hlstd{(tB.min} \hlopt{*} \hlstd{(}\hlnum{100}\hlopt{/}\hlstd{NB)),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Projection per 100 13.0875
\end{verbatim}
\begin{alltt}
\hlkwd{cat}\hlstd{(}\hlstr{"Propn bootstrap subgroups found ="}\hlstd{,} \hlkwd{c}\hlstd{(}\hlkwd{sum}\hlstd{(}\hlopt{!}\hlkwd{is.na}\hlstd{(resB}\hlopt{$}\hlstd{H_biasadj_1))}\hlopt{/}\hlstd{NB),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Propn bootstrap subgroups found = 0.9
\end{verbatim}
\begin{alltt}
\hlcom{# How many timmed out}
\hlkwd{cat}\hlstd{(}\hlstr{"Number timmed out="}\hlstd{,} \hlkwd{c}\hlstd{(}\hlkwd{sum}\hlstd{(}\hlkwd{is.na}\hlstd{(resB}\hlopt{$}\hlstd{H_biasadj_1)} \hlopt{&} \hlstd{resB}\hlopt{$}\hlstd{tmins_search} \hlopt{>} \hlstd{max.minutes)),}
    \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Number timmed out= 0
\end{verbatim}
\begin{alltt}
\hlstd{H_estimates} \hlkwb{<-} \hlkwd{get_dfRes}\hlstd{(}\hlkwc{Hobs} \hlstd{= H_obs,} \hlkwc{seHobs} \hlstd{= seH_obs,} \hlkwc{H1_adj} \hlstd{= resB}\hlopt{$}\hlstd{H_biasadj_1,}
    \hlkwc{ystar} \hlstd{= Ystar_mat,} \hlkwc{cov_method} \hlstd{=} \hlstr{"standard"}\hlstd{,} \hlkwc{cov_trim} \hlstd{=} \hlnum{0.05}\hlstd{)}

\hlstd{Hc_estimates} \hlkwb{<-} \hlkwd{get_dfRes}\hlstd{(}\hlkwc{Hobs} \hlstd{= Hc_obs,} \hlkwc{seHobs} \hlstd{= seHc_obs,} \hlkwc{H1_adj} \hlstd{= resB}\hlopt{$}\hlstd{Hc_biasadj_1,}
    \hlkwc{ystar} \hlstd{= Ystar_mat,} \hlkwc{cov_method} \hlstd{=} \hlstr{"standard"}\hlstd{,} \hlkwc{cov_trim} \hlstd{=} \hlnum{0.05}\hlstd{)}

\hlkwd{print}\hlstd{(H_estimates)}
\end{alltt}
\begin{verbatim}
##         H0     sdH0 H0_lower H0_upper       H1     sdH1     H1_lower H1_upper
## 1: 3.01229 1.456134  1.16796 7.769007 1.836783 7.727721 0.0004818136 7002.234
\end{verbatim}
\begin{alltt}
\hlkwd{print}\hlstd{(Hc_estimates)}
\end{alltt}
\begin{verbatim}
##           H0   sdH0  H0_lower H0_upper        H1      sdH1  H1_lower H1_upper
## 1: 0.7977977 0.1095 0.6096253 1.044053 0.8106109 0.2202354 0.4759364 1.380626
\end{verbatim}
\begin{alltt}
\hlkwa{if} \hlstd{(}\hlopt{!}\hlkwd{is.null}\hlstd{(outfsboot))} \hlkwd{save}\hlstd{(fs.est, Ystar_mat, resB, H_estimates, Hc_estimates,}
    \hlstd{df_boot_analysis,} \hlkwc{file} \hlstd{= outfsboot)}
\end{alltt}
\end{kframe}
\end{knitrout}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{t.done} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}
\hlstd{t.min} \hlkwb{<-} \hlstd{(t.done} \hlopt{-} \hlstd{t.start)}\hlopt{/}\hlnum{60}
\hlkwd{cat}\hlstd{(}\hlstr{"Minutes and hours for FS bootstrap"}\hlstd{,} \hlkwd{c}\hlstd{(t.min, t.min}\hlopt{/}\hlnum{60}\hlstd{),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Minutes and hours for FS bootstrap 1.312417 0.02187361
\end{verbatim}
\end{kframe}
\end{knitrout}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{df0.fs} \hlkwb{<-} \hlkwd{subset}\hlstd{(fs.est}\hlopt{$}\hlstd{df.pred, treat.recommend} \hlopt{==} \hlnum{0}\hlstd{)}
\hlstd{df1.fs} \hlkwb{<-} \hlkwd{subset}\hlstd{(fs.est}\hlopt{$}\hlstd{df.pred, treat.recommend} \hlopt{==} \hlnum{1}\hlstd{)}

\hlcom{# ITT analysis}
\hlstd{cox_itt} \hlkwb{<-} \hlkwd{summary}\hlstd{(}\hlkwd{coxph}\hlstd{(}\hlkwd{Surv}\hlstd{(time_days, cens)} \hlopt{~} \hlstd{treat,} \hlkwc{data} \hlstd{= fs.est}\hlopt{$}\hlstd{df.pred))}\hlopt{$}\hlstd{conf.int}

\hlcom{# ITT estimates}
\hlstd{resITT} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{round}\hlstd{(cox_itt[}\hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,} \hlnum{3}\hlstd{,} \hlnum{4}\hlstd{)],} \hlnum{2}\hlstd{),} \hlkwd{nrow}\hlstd{(fs.est}\hlopt{$}\hlstd{df.pred))}

\hlcom{# Forest Search Un-adjusted}
\hlstd{Hstat} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{unlist}\hlstd{(H_estimates))[}\hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,} \hlnum{3}\hlstd{,} \hlnum{4}\hlstd{)]}
\hlstd{resH_obs} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{c}\hlstd{(Hstat),} \hlkwd{nrow}\hlstd{(df0.fs))}
\hlcom{# Bias-corrected}
\hlstd{Hstat} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{unlist}\hlstd{(H_estimates))[}\hlkwd{c}\hlstd{(}\hlnum{5}\hlstd{,} \hlnum{7}\hlstd{,} \hlnum{8}\hlstd{)]}
\hlstd{resH_bc} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{c}\hlstd{(Hstat),} \hlkwd{nrow}\hlstd{(df0.fs))}

\hlstd{Hstat2} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{unlist}\hlstd{(H_estimates))[}\hlkwd{c}\hlstd{(}\hlnum{5}\hlstd{,} \hlnum{7}\hlstd{,} \hlnum{8}\hlstd{)]}
\hlstd{Hstat2} \hlkwb{<-} \hlkwd{round}\hlstd{(Hstat2,} \hlnum{2}\hlstd{)}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(Hstat2[}\hlnum{1}\hlstd{],} \hlstr{" ["}\hlstd{)}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(a, Hstat2[}\hlnum{2}\hlstd{])}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(a,} \hlstr{","}\hlstd{)}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(a, Hstat2[}\hlnum{3}\hlstd{])}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(a,} \hlstr{"]"}\hlstd{)}
\hlstd{H_bc2} \hlkwb{<-} \hlkwd{c}\hlstd{(a)}

\hlcom{# Un-adjusted}
\hlstd{Hcstat} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{unlist}\hlstd{(Hc_estimates))[}\hlkwd{c}\hlstd{(}\hlnum{1}\hlstd{,} \hlnum{3}\hlstd{,} \hlnum{4}\hlstd{)]}
\hlstd{resHc_obs} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{c}\hlstd{(Hcstat),} \hlkwd{nrow}\hlstd{(df1.fs))}
\hlcom{# Bias-corrected}
\hlstd{Hcstat} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{unlist}\hlstd{(Hc_estimates))[}\hlkwd{c}\hlstd{(}\hlnum{5}\hlstd{,} \hlnum{7}\hlstd{,} \hlnum{8}\hlstd{)]}
\hlstd{resHc_bc} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{c}\hlstd{(Hcstat),} \hlkwd{nrow}\hlstd{(df1.fs))}


\hlstd{Hcstat2} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlkwd{unlist}\hlstd{(Hc_estimates))[}\hlkwd{c}\hlstd{(}\hlnum{5}\hlstd{,} \hlnum{7}\hlstd{,} \hlnum{8}\hlstd{)]}
\hlstd{Hcstat2} \hlkwb{<-} \hlkwd{round}\hlstd{(Hcstat2,} \hlnum{2}\hlstd{)}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(Hcstat2[}\hlnum{1}\hlstd{],} \hlstr{" ["}\hlstd{)}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(a, Hcstat2[}\hlnum{2}\hlstd{])}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(a,} \hlstr{","}\hlstd{)}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(a, Hcstat2[}\hlnum{3}\hlstd{])}
\hlstd{a} \hlkwb{<-} \hlkwd{paste0}\hlstd{(a,} \hlstr{"]"}\hlstd{)}
\hlstd{Hc_bc2} \hlkwb{<-} \hlkwd{c}\hlstd{(a)}

\hlstd{res} \hlkwb{<-} \hlkwd{rbind}\hlstd{(resITT, resH_obs, resH_bc, resHc_obs, resHc_bc)}

\hlstd{resf} \hlkwb{<-} \hlkwd{as.data.frame}\hlstd{(res)}

\hlkwd{colnames}\hlstd{(resf)} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"HR Estimate"}\hlstd{,} \hlstr{"Lower"}\hlstd{,} \hlstr{"Upper"}\hlstd{,} \hlstr{"$\textbackslash{}\textbackslash{}#$ Subjects"}\hlstd{)}

\hlstd{rnH} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"$\textbackslash{}\textbackslash{}hat\{H\}$"}\hlstd{,} \hlstr{"$\textbackslash{}\textbackslash{}hat\{H\}_\{bc\}$"}\hlstd{)}
\hlstd{rnHc} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"$\textbackslash{}\textbackslash{}hat\{H\}^\{c\}$"}\hlstd{,} \hlstr{"$\textbackslash{}\textbackslash{}hat\{H\}^\{c\}_\{bc\}$"}\hlstd{)}
\hlstd{rnItt} \hlkwb{<-} \hlkwd{c}\hlstd{(}\hlstr{"ITT"}\hlstd{)}
\hlkwd{rownames}\hlstd{(resf)} \hlkwb{<-} \hlkwd{c}\hlstd{(rnItt, rnH, rnHc)}
\end{alltt}
\end{kframe}
\end{knitrout}


\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlcom{# Resolve conflict with dplyr}
\hlkwd{library}\hlstd{(conflicted)}
\hlstd{group_rows} \hlkwb{<-} \hlstd{kableExtra}\hlopt{::}\hlstd{group_rows}

\hlkwd{options}\hlstd{(}\hlkwc{knitr.kable.NA} \hlstd{=} \hlstr{"."}\hlstd{,} \hlkwc{format} \hlstd{=} \hlstr{"latex"}\hlstd{)}
\hlstd{tab_actg} \hlkwb{<-} \hlkwd{kbl}\hlstd{(resf,} \hlkwc{longtable} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{align} \hlstd{=} \hlstr{"c"}\hlstd{,} \hlkwc{format} \hlstd{=} \hlstr{"latex"}\hlstd{,} \hlkwc{booktabs} \hlstd{=} \hlnum{TRUE}\hlstd{,}
    \hlkwc{escape} \hlstd{= F,} \hlkwc{digits} \hlstd{=} \hlnum{3}\hlstd{,} \hlkwc{caption} \hlstd{=} \hlstr{"\textbackslash{}\textbackslash{}label\{tab:actg\} ACTG-175 FS Analysis: Cox hazard ratio (HR) estimates for the ITT population and subgroups $H$ and $H^\{c\}$.
Cox model estimates are based on subgroups: The estimated subgroup $\textbackslash{}\textbackslash{}hat\{H\}$; and 
the bootstrap ($B=2,000$) bias-correction to $\textbackslash{}\textbackslash{}hat\{H\}$ estimates, denoted $\textbackslash{}\textbackslash{}hat\{H\}_\{bc\}$.  Estimates for the complement $H^\{c\}$ are defined analogously.
The number of subjects in each population ($\textbackslash{}\textbackslash{}#$ Subjects) are listed."}\hlstd{)} \hlopt{%>%}
    \hlkwd{kable_styling}\hlstd{(}\hlkwc{full_width} \hlstd{=} \hlnum{FALSE}\hlstd{,} \hlkwc{font_size} \hlstd{=} \hlnum{9}\hlstd{,} \hlkwc{latex_options} \hlstd{=} \hlstr{"hold_position"}\hlstd{)} \hlopt{%>%}
    \hlkwd{group_rows}\hlstd{(}\hlstr{"ITT"}\hlstd{,} \hlnum{1}\hlstd{,} \hlnum{1}\hlstd{)} \hlopt{%>%}
    \hlkwd{group_rows}\hlstd{(}\hlstr{"H subgroup estimates"}\hlstd{,} \hlnum{2}\hlstd{,} \hlnum{3}\hlstd{)} \hlopt{%>%}
    \hlkwd{group_rows}\hlstd{(}\hlstr{"H-complement subgroup estimates"}\hlstd{,} \hlnum{4}\hlstd{,} \hlnum{5}\hlstd{)}
\end{alltt}
\end{kframe}
\end{knitrout}

\begin{table}[!h]

\caption{\label{tab:fs_tab}\label{tab:actg} ACTG-175 FS Analysis: Cox hazard ratio (HR) estimates for the ITT population and subgroups $H$ and $H^{c}$.
Cox model estimates are based on subgroups: The estimated subgroup $\hat{H}$; and 
the bootstrap ($B=2,000$) bias-correction to $\hat{H}$ estimates, denoted $\hat{H}_{bc}$.  Estimates for the complement $H^{c}$ are defined analogously.
The number of subjects in each population ($\#$ Subjects) are listed.}
\centering
\fontsize{9}{11}\selectfont
\begin{tabular}[t]{lcccc}
\toprule
  & HR Estimate & Lower & Upper & $\#$ Subjects\\
\midrule
\addlinespace[0.3em]
\multicolumn{5}{l}{\textbf{ITT}}\\
\hspace{1em}ITT & 0.900 & 0.690 & 1.160 & 1085\\
\addlinespace[0.3em]
\multicolumn{5}{l}{\textbf{H subgroup estimates}}\\
\hspace{1em}$\hat{H}$ & 3.012 & 1.168 & 7.769 & 106\\
\hspace{1em}$\hat{H}_{bc}$ & 1.837 & 0.000 & 7002.234 & 106\\
\addlinespace[0.3em]
\multicolumn{5}{l}{\textbf{H-complement subgroup estimates}}\\
\hspace{1em}$\hat{H}^{c}$ & 0.798 & 0.610 & 1.044 & 979\\
\hspace{1em}$\hat{H}^{c}_{bc}$ & 0.811 & 0.476 & 1.381 & 979\\
\bottomrule
\end{tabular}
\end{table}



\begin{knitrout}
\definecolor{shadecolor}{rgb}{0.969, 0.969, 0.969}\color{fgcolor}\begin{kframe}
\begin{alltt}
\hlstd{t.done} \hlkwb{<-} \hlkwd{proc.time}\hlstd{()[}\hlnum{3}\hlstd{]}
\hlstd{t.min} \hlkwb{<-} \hlstd{(t.done} \hlopt{-} \hlstd{t.start.all)}\hlopt{/}\hlnum{60}
\hlkwd{cat}\hlstd{(}\hlstr{"Minutes and hours to finish"}\hlstd{,} \hlkwd{c}\hlstd{(t.min, t.min}\hlopt{/}\hlnum{60}\hlstd{),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Minutes and hours to finish 4.647117 0.07745194
\end{verbatim}
\begin{alltt}
\hlkwd{cat}\hlstd{(}\hlstr{"Machine="}\hlstd{,} \hlkwd{c}\hlstd{(}\hlkwd{Sys.info}\hlstd{()[[}\hlnum{4}\hlstd{]]),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Machine= Mac-Studio-3.local
\end{verbatim}
\begin{alltt}
\hlkwd{cat}\hlstd{(}\hlstr{"Number of cores="}\hlstd{,} \hlkwd{c}\hlstd{(}\hlkwd{detectCores}\hlstd{(}\hlkwc{logical} \hlstd{=} \hlnum{FALSE}\hlstd{)),} \hlstr{"\textbackslash{}n"}\hlstd{)}
\end{alltt}
\begin{verbatim}
## Number of cores= 10
\end{verbatim}
\end{kframe}
\end{knitrout}


\end{document}


